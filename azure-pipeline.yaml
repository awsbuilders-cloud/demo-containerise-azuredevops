pool:
  vmImage: ubuntu-18.04

trigger:
  - master

stages:
  - stage: Prepare
    jobs:
      - job: InstallAwsCdk
        steps:
          - bash: |
              export AWS_ACCESS_KEY_ID="$(AWS_ACCESS_KEY_ID_ENCRYPTED)"
              export AWS_SECRET_ACCESS_KEY="$(AWS_SECRET_ACCESS_KEY_ENCRYPTED)"
              export GIT_COMMIT="$(Build.SourceVersion)"
              sudo npm install -g aws-cdk --allow-root
              cd infra
              npm install
              cdk deploy --require-approval never "container-meetup-environment"
              cdk deploy --require-approval never "container-meetup-application"
